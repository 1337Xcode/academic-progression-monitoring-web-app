<%- include('../../partials/header', { title: 'Manage Messages' }) %>
<section class="section">
    <div class="container">
        <h1 class="title">Manage Messages</h1>
        <% const page = 'manageMessages'; %>
        <%- include('../../partials/navbar', { page }) %>

        <% 
           const studentMessages = notifications.filter(m => m.Sender.role === 'STUDENT');
           const adminMessages   = notifications.filter(m => m.Sender.role === 'ADMIN');
        %>

        <div class="columns mt-4">
            <div class="column">
                <div class="box">
                    <p class="title is-5">Received Messages</p>
                    <% if (!studentMessages.length) { %>
                        <p>No messages from students.</p>
                    <% } else { %>
                        <% studentMessages.forEach(msg => { %>
                            <div class="notification is-light mb-2">
                                <strong>
                                    <%= msg.Sender.Student && msg.Sender.Student.first_name ? msg.Sender.Student.first_name : 'Unknown' %>
                                    <% if (msg.Sender.Student && msg.Sender.Student.sId) { %>
                                        (<%= msg.Sender.Student.sId %>)
                                    <% } %>
                                </strong>
                                <%= msg.message %><br>
                                <small><%= msg.sent_at ? msg.sent_at.toLocaleString() : '' %></small>
                            </div>
                        <% }) %>
                    <% } %>
                </div>
            </div>

            <div class="column">
                <div class="box">
                    <p class="title is-5">Sent Messages</p>
                    <% if (!adminMessages.length) { %>
                        <p>No sent messages.</p>
                    <% } else { %>
                        <% adminMessages.forEach(msg => { %>
                            <div class="notification is-primary mb-2">
                                <strong>
                                    To: 
                                    <% if (msg.student_id) { %>
                                        Student ID: <%= msg.student_id %>
                                    <% } else { %>
                                        All Students
                                    <% } %>
                                </strong>
                                <%= msg.message %><br>
                                <small><%= msg.sent_at ? msg.sent_at.toLocaleString() : '' %></small>
                            </div>
                        <% }) %>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="box">
            <p class="title is-5">Compose Message</p>
            <div class="card">
                <div class="card-content">
                    <form action="/admin/notifications/send" method="POST">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <div class="field">
                            <label class="label">Student ID (leave blank to send to all students)</label>
                            <div class="control">
                                <input class="input" type="text" name="studentId" placeholder="e.g. 22-IFSY-0933003">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Message</label>
                            <div class="control">
                                <textarea class="textarea" name="message" required maxlength="65535" placeholder="Type your message here"></textarea>
                            </div>
                        </div>
                        <div class="field mt-4">
                            <div class="control">
                                <button class="button is-primary is-fullwidth" type="submit">Send Message</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<%- include('../../partials/footer') %>

<script src="/js/messages.js"></script>
